<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing & Credits - Image Harvest</title>

    <!-- Preload critical resources -->
    <link rel="preload" href="css/optimized.css" as="style">
    <link rel="preload" href="css/mobile.css" as="style">
    <link rel="preload" href="css/billing-optimized.css" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">

    <!-- Critical CSS -->
    <link rel="stylesheet" href="css/optimized.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/billing-optimized.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        custom: '#123456',
                    },
                },
            },
        }
    </script>

    <!-- SEO and Social Meta -->
    <meta name="description" content="Manage your AI image generation credits, view payment history, and purchase additional credits securely with Stripe.">
    <meta name="keywords" content="AI image generation, credits, billing, payment, Stripe">

    <!-- Open Graph -->
    <meta property="og:title" content="Billing & Credits - Image Harvest">
    <meta property="og:description" content="Manage your AI image generation credits and payment history">
    <meta property="og:type" content="website">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="bg-gray-50">
    <!-- Skip to main content for accessibility -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-blue-600 text-white px-4 py-2 rounded">
        Skip to main content
    </a>

    <!-- Header Component loads automatically via header-component.js -->

    <main id="main-content" class="billing-container" style="margin-top: var(--top-margin-height);" role="main">

        <!-- Alert Messages -->
        <div id="error-message" class="error-message" role="alert" aria-live="polite"></div>
        <div id="success-message" class="success-message" role="alert" aria-live="polite"></div>

        <!-- Profile Management Section -->
        <section class="history-section" aria-label="Profile Management">
            <h2><i class="fas fa-user-cog" aria-hidden="true"></i> Profile Settings</h2>
            <div class="profile-section">
                <div class="profile-form">
                    <!-- Current Profile Display -->
                    <div class="current-profile-display">
                        <div class="profile-avatar-container">
                            <img id="current-avatar" src="" alt="Current profile picture" class="profile-avatar">
                            <div class="avatar-overlay">
                                <i class="fas fa-camera" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="profile-info">
                            <h3 id="current-username">Loading...</h3>
                            <p id="current-email">Loading...</p>
                        </div>
                    </div>

                    <!-- Username Change Form -->
                    <div class="form-group">
                        <label for="username-input" class="form-label">Username</label>
                        <div class="username-input-container">
                            <input
                                type="text"
                                id="username-input"
                                name="username"
                                placeholder="Enter new username"
                                class="form-input username-input"
                                maxlength="50"
                                aria-label="New username"
                                aria-describedby="username-help username-status"
                            >
                            <div class="username-actions">
                                <button id="update-username-btn" type="button" disabled>
                                    <i class="fas fa-save" aria-hidden="true"></i> Update
                                </button>
                            </div>
                        </div>
                        <div id="username-status" class="input-status" role="alert" aria-live="polite"></div>
                        <div id="username-help" class="form-help">
                            Choose a unique username. It will be visible to other users. Availability is checked automatically.
                        </div>
                    </div>

                    <!-- Avatar Selection -->
                    <div class="form-group">
                        <label class="form-label">Profile Picture</label>
                        <div class="avatar-options">
                            <!-- Upload Option -->
                            <div class="avatar-option">
                                <input type="radio" id="avatar-upload" name="avatar-type" value="upload" class="avatar-radio">
                                <label for="avatar-upload" class="avatar-option-label">
                                    <i class="fas fa-upload" aria-hidden="true"></i>
                                    <span>Upload Image</span>
                                </label>
                                <input type="file" id="avatar-file-input" accept="image/*" class="hidden" aria-label="Upload profile picture">
                            </div>

                            <!-- AI Generation Option -->
                            <div class="avatar-option">
                                <input type="radio" id="avatar-generate" name="avatar-type" value="generate" class="avatar-radio">
                                <label for="avatar-generate" class="avatar-option-label">
                                    <i class="fas fa-magic" aria-hidden="true"></i>
                                    <span>Generate with AI</span>
                                </label>
                            </div>

                            <!-- Existing Images Option -->
                            <div class="avatar-option">
                                <input type="radio" id="avatar-existing" name="avatar-type" value="existing" class="avatar-radio">
                                <label for="avatar-existing" class="avatar-option-label">
                                    <i class="fas fa-images" aria-hidden="true"></i>
                                    <span>Use Existing Image</span>
                                </label>
                            </div>
                        </div>

                        <!-- AI Generation Widget -->
                        <div id="ai-generation-form" class="ai-generation-form hidden">
                            <div id="profile-avatar-generator"></div>
                        </div>

                        <!-- Existing Images Grid -->
                        <div id="existing-images-grid" class="existing-images-grid hidden">
                            <div class="loading-placeholder">
                                <div class="loading-spinner" aria-hidden="true"></div>
                                <p>Loading your images...</p>
                            </div>
                        </div>

                        <!-- Upload Preview -->
                        <div id="upload-preview" class="upload-preview hidden">
                            <img id="upload-preview-img" src="" alt="Upload preview" class="upload-preview-image">
                            <button id="remove-upload" class="btn btn-danger btn-sm" type="button">
                                <i class="fas fa-times" aria-hidden="true"></i> Remove
                            </button>
                        </div>
                    </div>

                    <!-- Action buttons removed - each avatar type handles its own save operation -->

                    <!-- Profile Update Status -->
                    <div id="profile-update-status" class="profile-status" role="alert" aria-live="polite"></div>
                </div>
            </div>
        </section>

        <!-- Current Balance & Quick Actions -->
        <section class="billing-grid" aria-label="Account Overview">
            <!-- Current Balance Card -->
            <article class="billing-card">
                <h2><i class="fas fa-coins" aria-hidden="true"></i> Current Balance</h2>
                <div class="credit-balance">
                    <div id="current-credits" class="credit-amount" aria-label="Current credit balance">
                        <div class="skeleton-circle skeleton"></div>
                    </div>
                    <div class="credit-label">Available Credits</div>
                    <button id="add-credits-btn" class="add-credits-btn" aria-describedby="credits-help">
                        <i class="fas fa-plus" aria-hidden="true"></i> Add More Credits
                    </button>
                    <div id="credits-help" class="sr-only">
                        Click to view and purchase additional credit packages
                    </div>
                </div>
            </article>

            <!-- Usage Summary Card -->
            <article class="billing-card">
                <h2><i class="fas fa-chart-line" aria-hidden="true"></i> Usage Summary</h2>
                <div id="usage-summary">
                    <div class="skeleton-card">
                        <div class="skeleton-line skeleton"></div>
                        <div class="skeleton-line skeleton"></div>
                        <div class="skeleton-line skeleton"></div>
                        <div class="skeleton-line short skeleton"></div>
                    </div>

                    <!-- Content loaded by JavaScript -->
                    <div id="usage-content" class="hidden">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span>Total Images Generated:</span>
                            <strong id="total-images" aria-label="Total images generated">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span>Credits Used This Month:</span>
                            <strong id="monthly-usage" aria-label="Credits used this month">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span>Total Credits Purchased:</span>
                            <strong id="total-purchased" aria-label="Total credits purchased">-</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Account Created:</span>
                            <strong id="account-created" aria-label="Account creation date">-</strong>
                        </div>
                    </div>
                </div>
            </article>
        </section>

        <!-- Promo Code Section -->
        <section class="history-section" aria-label="Promo Code Redemption">
            <h2><i class="fas fa-ticket-alt" aria-hidden="true"></i> Redeem Promo Code</h2>
            <div class="promo-section">

                <div class="promo-form">
                    <div class="promo-input-group">
                        <input
                            type="text"
                            id="promo-code-input"
                            placeholder="Enter promo code (e.g., WELCOME5)"
                            class="promo-input"
                            maxlength="20"
                            aria-label="Promo code"
                        >
                        <button id="redeem-promo-btn" class="redeem-promo-btn">
                            <i class="fas fa-ticket-alt" aria-hidden="true"></i> Redeem
                        </button>
                    </div>
                    <div id="promo-message" class="promo-message" role="alert" aria-live="polite"></div>
                </div>
            </div>
        </section>

        <!-- Credit Packages Section -->
        <section id="credit-packages" class="hidden" aria-label="Credit Packages">
            <h2 style="text-align: center; margin-bottom: 2rem; color: #1f2937;">
                <i class="fas fa-shopping-cart" aria-hidden="true"></i> Choose Your Credit Package
            </h2>

            <div class="info-box">
                <h3><i class="fas fa-info-circle" aria-hidden="true"></i> How Credits Work</h3>
                <p>Each AI image generation uses credits based on the provider and settings. DALL-E 3 uses more credits than DALL-E 2, and multipliers increase credit usage. Credits never expire!</p>
            </div>

            <!-- Package Grid -->
            <div id="packages-grid" class="package-grid" role="list" aria-label="Available credit packages">
                <!-- Skeleton loading for packages -->
                <div class="skeleton-card skeleton">
                    <div class="skeleton-circle skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line short skeleton"></div>
                    <div class="skeleton-button skeleton"></div>
                </div>
                <div class="skeleton-card skeleton">
                    <div class="skeleton-circle skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line short skeleton"></div>
                    <div class="skeleton-button skeleton"></div>
                </div>
                <div class="skeleton-card skeleton">
                    <div class="skeleton-circle skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line short skeleton"></div>
                    <div class="skeleton-button skeleton"></div>
                </div>
                <div class="skeleton-card skeleton">
                    <div class="skeleton-circle skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line short skeleton"></div>
                    <div class="skeleton-button skeleton"></div>
                </div>
            </div>
        </section>

        <!-- Payment History Section -->
        <section class="history-section" aria-label="Payment History">
            <h2><i class="fas fa-history" aria-hidden="true"></i> Payment History</h2>
            <div id="payment-history">
                <!-- Skeleton loading -->
                <div class="skeleton-card">
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line medium skeleton"></div>
                </div>
            </div>
        </section>

        <!-- Credit History Section -->
        <section class="history-section" aria-label="Credit History">
            <h2><i class="fas fa-list" aria-hidden="true"></i> Credit History</h2>
            <div id="credit-history">
                <!-- Skeleton loading -->
                <div class="skeleton-card">
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line medium skeleton"></div>
                </div>
            </div>
        </section>

        <!-- Support Messages Section -->
        <section class="support-section" aria-label="Support Messages">
            <h2 class="text-2xl font-bold mb-4">Support Messages</h2>
            <div class="messaging-container" role="region" aria-label="Support conversation">
                <!-- Messages Display -->
                <div class="messages-display" id="messages-display" role="log" aria-live="polite" aria-label="Message history">
                    <div class="loading-placeholder">
                        <div class="loading-spinner" aria-hidden="true"></div>
                        <p>Loading messages...</p>
                    </div>
                </div>

                <!-- New Message Form -->
                <div class="new-message-form">
                    <form id="new-message-form" aria-label="Send support message">
                        <div class="form-group w-full">
                            <label for="message-input" class="sr-only">Type your message to support</label>
                            <textarea
                                id="message-input"
                                name="message"
                                placeholder="Type your message to support..."
                                rows="3"
                                maxlength="5000"
                                required
                                aria-describedby="char-count message-help"
                                aria-label="Message content"
                            ></textarea>
                            <div class="character-count" id="char-count" aria-live="polite">
                                <span>0</span>/5000
                            </div>
                            <div id="message-help" class="sr-only">
                                Enter your support message. Maximum 5000 characters.
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="send-message-btn" aria-describedby="send-help">
                                <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                Send Message
                            </button>
                            <div id="send-help" class="sr-only">
                                Send your message to support. You can send up to 5 messages per minute.
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Image History Section -->
        <section class="history-section" aria-label="Image History">
            <h2><i class="fas fa-history" aria-hidden="true"></i> Image History</h2>
            <div id="image-history">
                <!-- Skeleton loading -->
                <div class="skeleton-card">
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line skeleton"></div>
                    <div class="skeleton-line medium skeleton"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Scripts - loaded at end for performance -->
    <!-- Core Dependencies (must load first) -->
    <script type="module" src="js/core/constants.js"></script>
    <script src="js/core/api-service.js"></script>
    <script src="js/core/user-system.js"></script>

    <!-- Services -->
    <script type="module" src="js/services/UnifiedCreditService.js"></script>

    <!-- Components -->
    <script type="module" src="js/components/header-component.js"></script>
    <script type="module" src="js/components/credit-balance-widget.js"></script>
    <script type="module" src="js/components/global-credits-modal.js"></script>

    <!-- Modular Billing System (load in dependency order) -->
    <script src="js/modules/billing/billing-constants.js"></script>
    <script src="js/modules/billing/billing-api-manager.js"></script>
    <script src="js/modules/billing/billing-data-manager.js"></script>
    <script src="js/modules/billing/billing-dom-manager.js"></script>
    <script src="js/modules/billing/billing-ui-manager.js"></script>
    <script src="js/modules/billing/billing-manager.js"></script>

    <!-- Billing System Entry Point (load last) -->
    <script src="js/billing-modular.js"></script>

    <!-- Messaging System -->
    <script src="js/services/messaging-service.js"></script>
    <script src="js/components/messaging/message-component.js"></script>
    <script src="js/components/messaging/user-messaging.js"></script>

    <!-- AI Image Generator Widget -->
    <link rel="stylesheet" href="css/ai-image-generator-widget.css">

    <!-- Profile Management System -->
    <script type="module" src="js/modules/profile/profile-manager-refactored.js"></script>

    <!-- Performance monitoring (optional) -->
    <script>
        // Basic performance monitoring
        window.addEventListener('load', () => {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('🚀 Page Load Performance:', {
                    domContentLoaded: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
                    loadComplete: Math.round(perfData.loadEventEnd - perfData.loadEventStart),
                    totalTime: Math.round(perfData.loadEventEnd - perfData.fetchStart)
                });
            }
        });

        // Error tracking
        window.addEventListener('error', (event) => {
            console.error('🚨 JavaScript Error:', {
                message: event.message,
                filename: event.filename,
                line: event.lineno,
                column: event.colno
            });
        });

        // Unhandled promise rejection tracking
        window.addEventListener('unhandledrejection', (event) => {
            console.error('🚨 Unhandled Promise Rejection:', event.reason);
        });

    </script>
</body>
</html>
